#!/usr/bin/env python3

import argparse
import subprocess
import sys

COMMAND = ['cat']


def certs(iterator):
    '''Yields certificates from iterator.'''
    BEGIN = '-----BEGIN'
    END = '-----END'

    it = iter(iterator)
    cert_lines = []
    for line in it:
        if line.startswith(BEGIN) or cert_lines:
            cert_lines.append(line)
            if line.startswith(END):
                yield ''.join(cert_lines)
                cert_lines = []


if __name__ == '__main__':
    parser = argparse.ArgumentParser(
        usage='%(prog)s [options] [command]',
        description='''Read certificates from stdin and run command on each
        one. Default command is `{}`. '''.format(' '.join(COMMAND)))
    parser.add_argument(
        '--after', help='string to print after each result')
    (args, command) = parser.parse_known_args()

    command = (command or COMMAND)
    for cert in certs(sys.stdin):
        subprocess.run(command, input=str.encode(cert))
        if args.after is not None:
            print(args.after)

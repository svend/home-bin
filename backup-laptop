#!/usr/bin/env python3

import argparse
import json
import os
import subprocess
import sys
import time
from datetime import datetime, timedelta

TARGETS = ["~"]
PLATFORM_TARGETS = {"darwin": ["/nix", "/usr/local"]}
DATE_FILE = os.path.expanduser("~/.backup-laptop-dates")


def run_command(command, dry_run=False):
    command = ["echo"] + command if dry_run else command
    return subprocess.run(command, check=True)


def notify(message, dry_run=False):
    if sys.platform == "darwin":
        run_command(
            ["terminal-notifier", "-message", message, "-group", "backup-laptop"],
            dry_run=dry_run,
        )
    elif sys.platform == "linux":
        run_command(["notify-send", message], dry_run=dry_run)


def device_from_path(path, dry_run=False):
    command = ["findmnt", "--json", "--target", path]
    if dry_run:
        run_command(command, dry_run=dry_run)
        return "dry-run-device"
    else:
        proc = subprocess.run(command, check=True, stdout=subprocess.PIPE)
        j = json.loads(proc.stdout)
        return j["filesystems"][0]["source"]


def eject_drive(path, dry_run=False):
    if sys.platform == "darwin":
        run_command(["diskutil", "eject", path], dry_run=dry_run)
    elif sys.platform == "linux":
        dev = device_from_path(path, dry_run=dry_run)
        run_command(["gpg-luks", "close", dev], dry_run=dry_run)


def targets():
    extra_targets = PLATFORM_TARGETS.get(sys.platform, [])
    return [os.path.expanduser(p) for p in TARGETS + extra_targets]


def backup(repo, dry_run):
    os.environ["RESTIC_REPOSITORY"] = repo
    run_command(
        [
            "restic-gpg",
            "backup",
            "--one-file-system",
            "--exclude",
            os.path.expanduser("~/.rnd"),
        ]
        + targets(),
        dry_run=dry_run,
    )
    if not dry_run:
        with open(DATE_FILE, "a") as f:
            timestamp = datetime.utcnow().isoformat()
            f.write(f"{timestamp} {repo}\n")


def forget(repo, dry_run):
    os.environ["RESTIC_REPOSITORY"] = repo
    run_command(
        [
            "restic-gpg",
            "forget",
            "--prune",
            "--keep-daily",
            "7",
            "--keep-weekly",
            "5",
            "--keep-monthly",
            "12",
            "--keep-yearly",
            "75",
        ]
    )


def run(*, repo, eject=True, dry_run=False):
    repo = os.path.normpath(repo)
    start_time = time.time()
    backup(repo, dry_run=dry_run)
    forget(repo, dry_run=dry_run)
    end_time = time.time()
    duration = timedelta(seconds=int(end_time - start_time))
    if eject:
        eject_drive(os.path.dirname(repo), dry_run=dry_run)
    notify(f"Backup complete ({duration})", dry_run=dry_run)


def parse_args():
    parser = argparse.ArgumentParser(
        description="Backup laptop", argument_default=argparse.SUPPRESS
    )
    parser.add_argument("repo", help="path to restic repository")
    parser.add_argument(
        "--no-eject", help="do not eject the drive", action="store_false", dest="eject"
    )
    parser.add_argument("--dry-run", help="dry run mode", action="store_true")
    return parser.parse_args()


if __name__ == "__main__":
    args = parse_args()
    sys.exit(run(**vars(args)))
